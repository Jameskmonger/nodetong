<!doctype html>
<html>
  <head>
    <title>Nodetong</title>
	
	<style type="text/css">	
	body {
		margin: 0;
		overflow: hidden;
	}
	
	.player	{
		width: 30px;
		height: 30px;
		background-color: #ff0000;
		position: absolute;
		top: 0;
		left: 0;
		display: none;
		
		border-top: 2px solid black;
	}
	</style>
  </head>
  <body>	
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script>
	var socket = io();
	
	var local_player = {
		id: -1, 
		position: {
			x: 0,
			y: 0,
			orientation: 0
		}
	};
	
	socket.on("initialisation request", function(data) {
		local_player.id = data.id;
		local_player.position = data.position;
	});
	
	var Directions = { LEFT: 37, UP: 38, RIGHT: 39, DOWN: 40 };

	var keysPressed = [false, false, false, false];

	function updateKeysPressed(code, pressed){


		if (code === Directions.LEFT){
			keysPressed[0] = (pressed ? Directions.LEFT : false);
		}

		if (code === Directions.UP){
			keysPressed[1] = (pressed ? Directions.UP : false);
		}

		if (code === Directions.RIGHT){
			keysPressed[2] = (pressed ? Directions.RIGHT : false);
		}
		if (code === Directions.DOWN){
			keysPressed[3] = (pressed ? Directions.DOWN : false);
		}

		moveLocalPlayer();
	}

	$(document).keyup(function(e) {

		updateKeysPressed(e.keyCode, false);

	});

	$(document).keydown(function(e) {

        updateKeysPressed(e.keyCode, true);

		e.preventDefault(); // prevent the default action (scroll / move caret)
	});
	
	function moveLocalPlayer() {

		keysPressed.forEach(function(key){
			console.log(keysPressed);
			if(key){
				movePlayer(local_player.id, key);
			}
		});
	}
	
	socket.on("player join", function(data) {	
		addPlayer(data);
	});
	
	socket.on("player leave", function(id) {
		removePlayer(id);
	})
	
	function formatId(id) {
		return "player_" + id;
	}
	
	function formatIdSelector(id) {
		return ("#" + formatId(id));
	}
	
	function addPlayer(data) {
		$("body").append('<div class="player" id="' + formatId(data.id) + '">');
		
		$(formatIdSelector(data.id)).css({"display": "block", "top": data.position.y, "left": data.position.x, "background-color": "#" + data.color});
	}
	
	function removePlayer(id) {
		$(formatIdSelector(id)).remove();
	}
	
	function movePlayer(id, direction) {
		var element = $(".player#player_" + id);
	
		var delta = 5;
		var rotation = 1;
		
		if (direction === Directions.LEFT)
		{
			local_player.position.orientation -= rotation;
		}

		if (direction === Directions.RIGHT)
		{
			local_player.position.orientation += rotation;
		}

		if (direction === Directions.UP)
		{
			var angle = local_player.position.orientation - 90;

			local_player.position.x += delta * Math.cos(angle * Math.PI / 180);
			local_player.position.y += delta * Math.sin(angle * Math.PI / 180);
		}

		socket.emit("movement update", local_player.position);
	}
	  
	socket.on('position update', function(data) {
		var id = data.id;
	
		var player_css =
		{
			"top": data.position.y,
			"left": data.position.x,
			"-ms-transform": "rotate(" + data.position.orientation + "deg)",
			"-webkit-transform": "rotate(" + data.position.orientation + "deg)",
			"transform": "rotate(" + data.position.orientation + "deg)"
		};
	
		$(formatIdSelector(id)).css(player_css);
	});
	</script>
  </body>
</html>
