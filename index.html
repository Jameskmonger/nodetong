<!doctype html>
<html>
  <head>
    <title>Asteroids</title>

	<style type="text/css">
	body {
		margin: 0;
		overflow: hidden;
	}

	.player	{
		width: 0;
		height: 0;
		background-color: #ffffff;
		position: absolute;
		top: 0;
		left: 0;
		display: none;
		
		border-left: 15px solid transparent;
		border-right: 15px solid transparent;
	
		border-bottom: 30px solid;
		border-bottom-color: #ff0000;
	}

  .bullet	{
		width: 10px;
		height: 10px;
    border-radius: 50%;
		background-color: #000000;
		position: absolute;
		top: 0;
		left: 0;
		display: none;
		border-top: 2px solid black;
	}

	</style>
  </head>
  <body>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script>
	var socket = io();

	var local_player = {
		id: -1,
		position: {
			x: 0,
			y: 0,
			orientation: 0
		}
	};

	socket.on("initialisation request", function(data) {
		local_player.id = data.id;
		local_player.position = data.position;
	});

	var Directions = {
    LEFT: 37,
    UP: 38,
    RIGHT: 39,
    DOWN: 40,
    SHOOT: 32};

	var keysPressed = [false, false, false, false];

	function updateKeysPressed(code, pressed){

		if (code === Directions.LEFT){
			keysPressed[0] = (pressed ? Directions.LEFT : false);
		}

		if (code === Directions.UP){
			keysPressed[1] = (pressed ? Directions.UP : false);
		}

		if (code === Directions.RIGHT){
			keysPressed[2] = (pressed ? Directions.RIGHT : false);
		}
		if (code === Directions.DOWN){

			keysPressed[3] = (pressed ? Directions.DOWN : false);
		}

		moveLocalPlayer();
	}

	$(document).keyup(function(e) {

		updateKeysPressed(e.keyCode, false);

	});

	$(document).keydown(function(e) {

    if (e.keyCode === Directions.SHOOT){
			shoot();
		}

    updateKeysPressed(e.keyCode, true);

		e.preventDefault(); // prevent the default action (scroll / move caret)
	});

	function moveLocalPlayer() {

		keysPressed.forEach(function(key){
			if(key){
				movePlayer(local_player.id, key);
			}
		});
	}

  socket.on("bullet out", function(data) {

	if ($('#' + data.id).length == 0) {
     	$("body").append('<div class="bullet" id="' + data.id + '">');
     
     }
     
     $('#' + data.id).css({"display": "block", "top": data.y, "left": data.x});
	});

	socket.on("player join", function(data) {
		addPlayer(data);
	});

	socket.on("player leave", function(id) {
		removePlayer(id);
	})

	function formatId(id) {
		return "player_" + id;
	}

	function formatIdSelector(id) {
		return ("#" + formatId(id));
	}


  function shoot() {

	var bulletPosition = local_player.position;

	socket.emit("bullet in", bulletPosition);
	}

	function addPlayer(data) {
		$("body").append('<div class="player" id="' + formatId(data.id) + '">');

		$(formatIdSelector(data.id)).css({"display": "block", "top": data.position.y, "left": data.position.x, "border-bottom-color": "#" + data.color});
	}

	function removePlayer(id) {
		$(formatIdSelector(id)).remove();
	}

	function movePlayer(id, direction) {
		var element = $(".player#player_" + id);

		var delta = 5;
		var rotation = 10;

		if (direction === Directions.LEFT)
		{
			local_player.position.orientation -= rotation;
		}

		if (direction === Directions.RIGHT)
		{
			local_player.position.orientation += rotation;
		}

		if (direction === Directions.UP)
		{
			var angle = local_player.position.orientation - 90;

			local_player.position.x += delta * Math.cos(angle * Math.PI / 180);
			local_player.position.y += delta * Math.sin(angle * Math.PI / 180);
		}

		socket.emit("movement update", local_player.position);
	}

	socket.on('position update', function(data) {
		var id = data.id;

		var player_css =
		{
			"top": data.position.y,
			"left": data.position.x,
			"-ms-transform": "rotate(" + data.position.orientation + "deg)",
			"-webkit-transform": "rotate(" + data.position.orientation + "deg)",
			"transform": "rotate(" + data.position.orientation + "deg)"
		};

		$(formatIdSelector(id)).css(player_css);
	});
	</script>
  </body>
</html>
