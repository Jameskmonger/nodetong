<!doctype html>
<html>
<head>
  <script src="victor.min.js" type="text/javascript"></script>
</head>
<body>
  <canvas id="wheels" width="300" height="300"></canvas>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', loaded, false);

    var KEY_CODE_SPACE = 32, KEY_CODE_LEFT = 37, KEY_CODE_UP = 38, KEY_CODE_RIGHT = 39;

    var wheelRotation = 90;

    document.addEventListener("keydown", function(event) {
      if (event.keyCode == KEY_CODE_LEFT) {
        decreaseWheelRotation(1);
      }

      if (event.keyCode == KEY_CODE_RIGHT) {
        increaseWheelRotation(1);
      }

      if (event.keyCode == KEY_CODE_UP) {
        speed = new Victor(3, 3);
      }

      if (event.keyCode == KEY_CODE_SPACE) {
        draw();
      }
    });

    function decreaseWheelRotation(amount) {
      setWheelRotation(wheelRotation - amount);
      return;
    }

    function increaseWheelRotation(amount) {
      setWheelRotation(wheelRotation + amount);
      return;
    }

    function setWheelRotation(rotation) {
      if (rotation < 60) {
        return;
      }

      if (rotation > 120) {
        return;
      }

      wheelRotation = rotation;
      draw();
      return;
    }

    function loaded() {
      draw();
    }

    var carrot = 0;

    function cr(deg) {
      carrot = deg;
      draw();
    }

    var DRAW_DEBUG_LINES = true;

    var speed = new Victor(0, 0);

    function draw() {
      var canvas = document.getElementById('wheels');
      var ctx = canvas.getContext('2d');

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      drawCar(20, 20, carrot);

      function drawCar(car_x, car_y, rotation) {
        // http://engineeringdotnet.blogspot.co.uk/2010/04/simple-2d-car-physics-in-games.html

        var wheel_width = 5, wheel_length = 11;
        var car_width = 21, car_height = 25;

        var wheel_base = car_height + wheel_length / 4;

        var center_x = (car_x - wheel_width + car_width);
        var center_y = (car_y - wheel_length + car_height) + 1;

        var car_location_vector = new Victor(center_x, center_y);

        var rotation_rad = rotation * (Math.PI / 180)
        var wheel_rotation_rad = wheelRotation * (Math.PI / 180);

        var cos_r = Math.cos(rotation_rad), sin_r = Math.sin(rotation_rad);
        var rotation_vector = new Victor(cos_r, sin_r);

        var half_wheel_base = (wheel_base / 2);
        var half_wheel_base_vector = new Victor(half_wheel_base, half_wheel_base);

        var front_wheel_vector = rotation_vector.clone().multiply(half_wheel_base_vector).add(car_location_vector);
        var back_wheel_vector = rotation_vector.clone().multiply(half_wheel_base_vector).subtract(car_location_vector);

        var cos_r1 = Math.cos(rotation_rad), sin_r1 = Math.sin(rotation_rad);
        var cos_rs = Math.cos(rotation_rad + wheel_rotation_rad), sin_rs = Math.sin(rotation_rad + wheel_rotation_rad);

        var add_to_front = speed.clone().multiply(new Victor(cos_rs, sin_rs));
        var add_to_back = speed.clone().multiply(new Victor(cos_r1, sin_r1));

        front_wheel_vector.add(add_to_front);
        back_wheel_vector.add(add_to_back);

        var both_wheels = front_wheel_vector.clone().add(back_wheel_vector);
        car_location_vector = both_wheels.multiply(new Victor(0.5, 0.5));

        rotation = Math.atan2(front_wheel_vector.y - back_wheel_vector.y, front_wheel_vector.x - back_wheel_vector.x);

        center_x = car_location_vector.x;
        center_y = car_location_vector.y;

        if (DRAW_DEBUG_LINES) {
          ctx.save();
          ctx.fillStyle = "#ff0000";
          ctx.fillRect(car_x - 4, car_y + 1, 2, wheel_base);
          ctx.restore();
        }

        ctx.save();

        ctx.translate(center_x, center_y);
        ctx.rotate(rotation * Math.PI / 180);
        ctx.translate(-(center_x), -(center_y));

        var front_left_wheel_x = (center_x - car_width + wheel_width);
        var front_left_wheel_y = (center_y - car_height + wheel_length) - 1;

        var front_right_wheel_x = front_left_wheel_x + car_width;
        var front_right_wheel_y = front_left_wheel_y;

        drawRotatedRect(front_left_wheel_x, front_left_wheel_y, wheel_length, wheel_width, wheelRotation);
        drawRotatedRect(front_right_wheel_x, front_right_wheel_y, wheel_length, wheel_width, wheelRotation);

        var back_left_wheel_x = (center_x - car_width + wheel_width);
        var back_left_wheel_y = (center_y + wheel_length) - 1;

        var back_right_wheel_x = back_left_wheel_x + car_width;
        var back_right_wheel_y = back_left_wheel_y;

        drawRotatedRect(back_left_wheel_x, back_left_wheel_y, wheel_length, wheel_width, 90);
        drawRotatedRect(back_right_wheel_x, back_right_wheel_y, wheel_length, wheel_width, 90);

        if (DRAW_DEBUG_LINES) {
          ctx.save();
          ctx.fillStyle = "#ff0000";
          ctx.fillRect(center_x - 2, center_y - 2, 4, 4);
          ctx.restore();
        }

        ctx.restore();
      }

      function drawRotatedRect(x, y, width, height, rotation) {
        ctx.save();
        ctx.translate(x + width / 2, y + height / 2);
        ctx.rotate(rotation * Math.PI / 180);
        ctx.fillRect(-width / 2, -height / 2, width, height);
        ctx.restore();
      }
    }
  </script>
</body>
</html>
